<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin • MABP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="/">MABP Admin</a>
    <div class="d-flex">
      <a class="btn btn-outline-light" href="/logout">Logout</a>
    </div>
  </div>
</nav>

<div class="container py-4">

  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <div class="card p-3 shadow-sm">
        <h5>Upload Data Sheets</h5>
        <p class="text-muted mb-2">Allowed: .xlsx, .xls, .csv (5 slots for different datasets)</p>

        <div class="mb-2">
          <label class="form-label">Sheet 1</label>
          <input class="form-control" type="file" id="f1" accept=".xlsx,.xls,.csv">
          <button class="btn btn-success mt-2" onclick="upload('sheet1','f1')">Upload</button>
          <div id="p1" class="progress mt-2 d-none"><div class="progress-bar" style="width:0%">0%</div></div>
        </div>

        <div class="mb-2">
          <label class="form-label">Sheet 2</label>
          <input class="form-control" type="file" id="f2" accept=".xlsx,.xls,.csv">
          <button class="btn btn-success mt-2" onclick="upload('sheet2','f2')">Upload</button>
          <div id="p2" class="progress mt-2 d-none"><div class="progress-bar" style="width:0%">0%</div></div>
        </div>

        <div class="mb-2">
          <label class="form-label">Sheet 3</label>
          <input class="form-control" type="file" id="f3" accept=".xlsx,.xls,.csv">
          <button class="btn btn-success mt-2" onclick="upload('sheet3','f3')">Upload</button>
          <div id="p3" class="progress mt-2 d-none"><div class="progress-bar" style="width:0%">0%</div></div>
        </div>

        <div class="mb-2">
          <label class="form-label">Sheet 4</label>
          <input class="form-control" type="file" id="f4" accept=".xlsx,.xls,.csv">
          <button class="btn btn-success mt-2" onclick="upload('sheet4','f4')">Upload</button>
          <div id="p4" class="progress mt-2 d-none"><div class="progress-bar" style="width:0%">0%</div></div>
        </div>

        <div class="mb-2">
          <label class="form-label">Sheet 5</label>
          <input class="form-control" type="file" id="f5" accept=".xlsx,.xls,.csv">
          <button class="btn btn-success mt-2" onclick="upload('sheet5','f5')">Upload</button>
          <div id="p5" class="progress mt-2 d-none"><div class="progress-bar" style="width:0%">0%</div></div>
        </div>

        <div id="uploadMsg" class="text-muted mt-2"></div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card p-3 shadow-sm">
        <h5>User Management</h5>
        <div class="row g-2">
          <div class="col-12 col-md-4"><input id="uUser" class="form-control" placeholder="Username"></div>
          <div class="col-12 col-md-4"><input id="uPass" class="form-control" placeholder="Password" type="password"></div>
          <div class="col-12 col-md-4">
            <select id="uRole" class="form-select">
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="col-12"><button class="btn btn-primary" onclick="createUser()">Create User</button></div>
        </div>
        <hr>
        <h6>Existing Users</h6>
        <ul id="usersList" class="list-group small"></ul>
      </div>
    </div>
  </div>

</div>

<script>
function showProgress(id, pct){
  const wrap = document.getElementById(id);
  if(wrap.classList.contains('d-none')) wrap.classList.remove('d-none');
  const bar = wrap.querySelector('.progress-bar');
  bar.style.width = pct + '%'; bar.textContent = pct + '%';
}
function upload(slot, inputId){
  const inp = document.getElementById(inputId);
  const file = inp.files[0];
  if(!file){ alert('Select a file'); return; }
  const fd = new FormData(); fd.append('file', file);
  const xhr = new XMLHttpRequest();
  xhr.open('POST', `/api/admin/upload/${slot}`, true);
  xhr.upload.onprogress = (e)=>{ if(e.lengthComputable){ showProgress('p' + inputId.substring(1), Math.round((e.loaded/e.total)*100)); } };
  xhr.onload = ()=>{ document.getElementById('uploadMsg').textContent = xhr.status===200 ? ('Uploaded ' + file.name + ' to ' + slot) : ('Upload failed: ' + xhr.responseText); };
  xhr.onerror = ()=>{ document.getElementById('uploadMsg').textContent = 'Network error'; };
  xhr.send(fd);
}
async function createUser(){
  const username = document.getElementById('uUser').value.trim();
  const password = document.getElementById('uPass').value.trim();
  const role = document.getElementById('uRole').value;
  if(!username || !password){ alert('Username & password required'); return; }
  const resp = await fetch('/api/admin/create_user', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username, password, role, permissions: role==='admin'?['all']:[]})});
  const j = await resp.json(); if(!j.ok){ alert('Failed: ' + (j.error||'unknown')); return; }
  loadUsers();
}
async function loadUsers(){
  const ul = document.getElementById('usersList'); ul.innerHTML = '<li class="list-group-item">Loading...</li>';
  const r = await fetch('/api/admin/list_users'); const j = await r.json();
  if(!j.ok){ ul.innerHTML = '<li class="list-group-item text-danger">Failed to load users</li>'; return; }
  ul.innerHTML = ''; j.users.forEach(u=>{ const li = document.createElement('li'); li.className = 'list-group-item d-flex justify-content-between align-items-center'; li.textContent = `${u.username} — ${u.role}`; ul.appendChild(li); });
}
loadUsers();
</script>
</body>
</html>